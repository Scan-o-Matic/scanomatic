import React from 'react';
import { shallow, mount } from 'enzyme';

import './enzyme-setup';
import PolynomialResultsPlotScatter from '../../ccc/components/PolynomialResultsPlotScatter';

const toLookLikeSVG = (util, customEqualityTesters) => ({
    compare: (actual, expected) => {
        const expectedData = expected.match(/<svg.*<\/svg>/)[0];
        const expectedDataURL = `data://text/svg,${expectedData}`;
        const actualData = actual.match(/<svg.*<\/svg>/)[0];
        const actualDataURL = `data://text/svg,${actualData}`;
        const result = {
            pass: util.equals(actual, expected, customEqualityTesters),
        };
        result.message = result.pass ? 'Expected SVGs to look different' : 'Expected SVGs to look the same';
        result.message += `\n\texpected: ${expectedDataURL}`;
        result.message += `\n\tactual: " ${actualDataURL}`;
        return result;
    },
});

describe('<PolynomialResultsPlotScatter />', () => {
    const props = {
        resultsData: {
            calculated: [1, 2, 3, 4, 5],
            independentMeasurements: [2, 2, 3, 4, 5],
        },
        correlation: {
            slope: 4,
            intercept: 10,
            stderr: 0.11,
        }
    };

    beforeEach(() => {
        jasmine.addMatchers({ toLookLikeSVG });
    });

    it('renders a div to place the plot in', () => {
        const wrapper = shallow(<PolynomialResultsPlotScatter {...props} />);
        expect(wrapper.find('div.poly-corr-chart').exists()).toBeTruthy();
    });

    it('renders the title', () => {
        const wrapper = shallow(<PolynomialResultsPlotScatter {...props} />);
        expect(wrapper.find('h4').exists()).toBeTruthy();
        expect(wrapper.find('h4').text())
            .toEqual('Population Size Correlation');
    });

    it('renders summary paragraph', () => {
        const { slope, intercept, stderr } = props.correlation;
        const wrapper = shallow(<PolynomialResultsPlotScatter {...props} />);
        expect(wrapper.find('p').exists()).toBeTruthy();
        expect(wrapper.find('p').text())
            .toEqual(`Correlation: y = ${slope.toFixed(2)}x + ${intercept.toFixed(0)} (standard error ${stderr})`);
    });

    it('plots the data', () => {
        const clock = jasmine.clock().install();
        clock.mockDate(new Date(42));
        const wrapper = mount(<PolynomialResultsPlotScatter {...props} />);
        const expected = '<div class="poly-corr-chart c3" style="max-height: 500px; position: relative;"><svg width="500" height="500" style="overflow: hidden;"><defs><clipPath id="c3-42-clip"><rect width="463" height="446"></rect></clipPath><clipPath id="c3-42-clip-xaxis"><rect x="-31" y="-20" width="525" height="70"></rect></clipPath><clipPath id="c3-42-clip-yaxis"><rect x="-29" y="-4" width="50" height="470"></rect></clipPath><clipPath id="c3-42-clip-grid"><rect width="463" height="446"></rect></clipPath><clipPath id="c3-42-clip-subchart"><rect width="463"></rect></clipPath></defs><g transform="translate(30.5,4.5)"><text class="c3-text c3-empty" text-anchor="middle" dominant-baseline="middle" x="231.5" y="223"></text><rect class="c3-zoom-rect" width="463" height="446" style="opacity: 0;"></rect><g clip-path="url(http://localhost:9876/context.html#c3-42-clip)" class="c3-regions" style="visibility: visible;"></g><g clip-path="url(http://localhost:9876/context.html#c3-42-clip-grid)" class="c3-grid" style="visibility: visible;"><g class="c3-xgrid-focus"><line class="c3-xgrid-focus" x1="-10" x2="-10" y1="0" y2="446" style="visibility: hidden;"></line></g></g><g clip-path="url(http://localhost:9876/context.html#c3-42-clip)" class="c3-chart"><g class="c3-event-rects c3-event-rects-multiple" style="fill-opacity: 0;"><rect x="0" y="0" width="463" height="446" class=" c3-event-rect c3-event-rect"></rect></g><g class="c3-chart-bars"><g class="c3-chart-bar c3-target c3-target-calculated" style="pointer-events: none;"><g class=" c3-shapes c3-shapes-calculated c3-bars c3-bars-calculated" style="cursor: pointer;"></g></g><g class="c3-chart-bar c3-target c3-target-Identity-Line" style="pointer-events: none;"><g class=" c3-shapes c3-shapes-Identity-Line c3-bars c3-bars-Identity-Line" style="cursor: pointer;"></g></g><g class="c3-chart-bar c3-target c3-target-Correlation" style="pointer-events: none;"><g class=" c3-shapes c3-shapes-Correlation c3-bars c3-bars-Correlation" style="cursor: pointer;"></g></g></g><g class="c3-chart-lines"><g class="c3-chart-line c3-target c3-target-calculated" style="opacity: 0; pointer-events: none;"><g class=" c3-shapes c3-shapes-calculated c3-lines c3-lines-calculated"></g><g class=" c3-shapes c3-shapes-calculated c3-areas c3-areas-calculated"></g><g class=" c3-selected-circles c3-selected-circles-calculated"></g><g class=" c3-shapes c3-shapes-calculated c3-circles c3-circles-calculated" style="cursor: pointer;"><circle class=" c3-shape c3-shape-0 c3-circle c3-circle-0" r="4" cx="156" cy="398.0098039215686" style="fill: rgb(31, 119, 180); opacity: 0.5;"></circle><circle class=" c3-shape c3-shape-1 c3-circle c3-circle-1" r="4" cx="156" cy="387.1029411764706" style="fill: rgb(31, 119, 180); opacity: 0.5;"></circle><circle class=" c3-shape c3-shape-2 c3-circle c3-circle-2" r="4" cx="232" cy="376.1960784313726" style="fill: rgb(31, 119, 180); opacity: 0.5;"></circle><circle class=" c3-shape c3-shape-3 c3-circle c3-circle-3" r="4" cx="308" cy="365.28921568627453" style="fill: rgb(31, 119, 180); opacity: 0.5;"></circle><circle class=" c3-shape c3-shape-4 c3-circle c3-circle-4" r="4" cx="383" cy="354.3823529411764" style="fill: rgb(31, 119, 180); opacity: 0.5;"></circle></g></g><g class="c3-chart-line c3-target c3-target-Identity-Line" style="opacity: 0; pointer-events: none;"><g class=" c3-shapes c3-shapes-Identity-Line c3-lines c3-lines-Identity-Line"><path class=" c3-shape c3-shape c3-line c3-line-Identity-Line" d="M5,408.91666666666663L459,343.4754901960784" style="stroke: rgb(255, 127, 14); opacity: 1;"></path></g><g class=" c3-shapes c3-shapes-Identity-Line c3-areas c3-areas-Identity-Line"><path class=" c3-shape c3-shape c3-area c3-area-Identity-Line" d="M 5 408.91666666666663" style="fill: rgb(255, 127, 14); opacity: 0;"></path></g><g class=" c3-selected-circles c3-selected-circles-Identity-Line"></g><g class=" c3-shapes c3-shapes-Identity-Line c3-circles c3-circles-Identity-Line" style="cursor: pointer;"><circle class=" c3-shape c3-shape-0 c3-circle c3-circle-0" r="4" cx="5" cy="408.91666666666663" style="fill: rgb(255, 127, 14); opacity: 1;"></circle><circle class=" c3-shape c3-shape-1 c3-circle c3-circle-1" r="4" cx="459" cy="343.4754901960784" style="fill: rgb(255, 127, 14); opacity: 1;"></circle></g></g><g class="c3-chart-line c3-target c3-target-Correlation" style="opacity: 0; pointer-events: none;"><g class=" c3-shapes c3-shapes-Correlation c3-lines c3-lines-Correlation"><path class=" c3-shape c3-shape c3-line c3-line-Correlation" d="M5,299.84803921568624L459,38.0833333333333" style="stroke: rgb(44, 160, 44); opacity: 1;"></path></g><g class=" c3-shapes c3-shapes-Correlation c3-areas c3-areas-Correlation"><path class=" c3-shape c3-shape c3-area c3-area-Correlation" d="M 5 299.84803921568624" style="fill: rgb(44, 160, 44); opacity: 0;"></path></g><g class=" c3-selected-circles c3-selected-circles-Correlation"></g><g class=" c3-shapes c3-shapes-Correlation c3-circles c3-circles-Correlation" style="cursor: pointer;"><circle class=" c3-shape c3-shape-0 c3-circle c3-circle-0" r="4" cx="5" cy="299.84803921568624" style="fill: rgb(44, 160, 44); opacity: 1;"></circle><circle class=" c3-shape c3-shape-1 c3-circle c3-circle-1" r="4" cx="459" cy="38.0833333333333" style="fill: rgb(44, 160, 44); opacity: 1;"></circle></g></g></g><g class="c3-chart-arcs" transform="translate(231.5,218)"><text class="c3-chart-arcs-title" style="text-anchor: middle; opacity: 0;"></text></g><g class="c3-chart-texts"><g class="c3-chart-text c3-target c3-target-calculated" style="opacity: 0; pointer-events: none;"><g class=" c3-texts c3-texts-calculated"></g></g><g class="c3-chart-text c3-target c3-target-Identity-Line" style="opacity: 0; pointer-events: none;"><g class=" c3-texts c3-texts-Identity-Line"></g></g><g class="c3-chart-text c3-target c3-target-Correlation" style="opacity: 0; pointer-events: none;"><g class=" c3-texts c3-texts-Correlation"></g></g></g></g><g clip-path="url(http://localhost:9876/context.html#c3-42-clip-grid)" class="c3-grid c3-grid-lines"><g class="c3-xgrid-lines"></g><g class="c3-ygrid-lines"></g></g><g class="c3-axis c3-axis-x" clip-path="url(http://localhost:9876/context.html#c3-42-clip-xaxis)" transform="translate(0,446)" style="visibility: visible; opacity: 1;"><text class="c3-axis-x-label" transform="" x="463" dx="-0.5em" dy="-0.5em" style="text-anchor: end;">Independent Measurements</text><g class="tick" transform="translate(5, 0)" style="opacity: 1;"><line x1="0" x2="0" y2="6"></line><text x="0" y="9" transform="" style="text-anchor: middle; display: block;"><tspan x="0" dy=".71em" dx="0">0</tspan></text></g><g class="tick" transform="translate(459, 0)" style="opacity: 1;"><line x1="0" x2="0" y2="6"></line><text x="0" y="9" transform="" style="text-anchor: middle; display: block;"><tspan x="0" dy=".71em" dx="0">6</tspan></text></g><path class="domain" d="M0,6V0H463V6"></path></g><g class="c3-axis c3-axis-y" clip-path="url(http://localhost:9876/context.html#c3-42-clip-yaxis)" transform="translate(0,0)" style="visibility: visible; opacity: 1;"><text class="c3-axis-y-label" transform="rotate(-90)" x="0" dx="-0.5em" dy="1.2em" style="text-anchor: end;">Calculated</text><g class="tick" transform="translate(0,409)" style="opacity: 1;"><line x2="-6"></line><text x="-9" y="0" style="text-anchor: end;"><tspan x="-9" dy="3">0</tspan></text></g><g class="tick" transform="translate(0,344)" style="opacity: 1;"><line x2="-6"></line><text x="-9" y="0" style="text-anchor: end;"><tspan x="-9" dy="3">6</tspan></text></g><path class="domain" d="M-6,1H0V446H-6"></path></g><g class="c3-axis c3-axis-y2" transform="translate(463,0)" style="visibility: hidden; opacity: 1;"><text class="c3-axis-y2-label" transform="rotate(-90)" x="0" dx="-0.5em" dy="-0.5em" style="text-anchor: end;"></text><g class="tick" transform="translate(0,446)" style="opacity: 1;"><line x2="6" y2="0"></line><text x="9" y="0" style="text-anchor: start;"><tspan x="9" dy="3">0</tspan></text></g><g class="tick" transform="translate(0,402)" style="opacity: 1;"><line x2="6" y2="0"></line><text x="9" y="0" style="text-anchor: start;"><tspan x="9" dy="3">0.1</tspan></text></g><g class="tick" transform="translate(0,357)" style="opacity: 1;"><line x2="6" y2="0"></line><text x="9" y="0" style="text-anchor: start;"><tspan x="9" dy="3">0.2</tspan></text></g><g class="tick" transform="translate(0,313)" style="opacity: 1;"><line x2="6" y2="0"></line><text x="9" y="0" style="text-anchor: start;"><tspan x="9" dy="3">0.3</tspan></text></g><g class="tick" transform="translate(0,268)" style="opacity: 1;"><line x2="6" y2="0"></line><text x="9" y="0" style="text-anchor: start;"><tspan x="9" dy="3">0.4</tspan></text></g><g class="tick" transform="translate(0,224)" style="opacity: 1;"><line x2="6" y2="0"></line><text x="9" y="0" style="text-anchor: start;"><tspan x="9" dy="3">0.5</tspan></text></g><g class="tick" transform="translate(0,179)" style="opacity: 1;"><line x2="6" y2="0"></line><text x="9" y="0" style="text-anchor: start;"><tspan x="9" dy="3">0.6</tspan></text></g><g class="tick" transform="translate(0,135)" style="opacity: 1;"><line x2="6" y2="0"></line><text x="9" y="0" style="text-anchor: start;"><tspan x="9" dy="3">0.7</tspan></text></g><g class="tick" transform="translate(0,90)" style="opacity: 1;"><line x2="6" y2="0"></line><text x="9" y="0" style="text-anchor: start;"><tspan x="9" dy="3">0.8</tspan></text></g><g class="tick" transform="translate(0,46)" style="opacity: 1;"><line x2="6" y2="0"></line><text x="9" y="0" style="text-anchor: start;"><tspan x="9" dy="3">0.9</tspan></text></g><g class="tick" transform="translate(0,1)" style="opacity: 1;"><line x2="6" y2="0"></line><text x="9" y="0" style="text-anchor: start;"><tspan x="9" dy="3">1</tspan></text></g><path class="domain" d="M6,1H0V446H6"></path></g></g><g transform="translate(20.5,500.5)" style="visibility: hidden;"><g clip-path="url(http://localhost:9876/context.html#c3-42-clip-subchart)" class="c3-chart"><g class="c3-chart-bars"></g><g class="c3-chart-lines"></g></g><g clip-path="url(http://localhost:9876/context.html#c3-42-clip)" class="c3-brush" style="pointer-events: all; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><rect class="background" x="0" width="473" style="visibility: hidden; cursor: crosshair;"></rect><rect class="extent" x="0" width="0" style="cursor: move;"></rect><g class="resize e" transform="translate(0,0)" style="cursor: ew-resize; display: none;"><rect x="-3" width="6" height="6" style="visibility: hidden;"></rect></g><g class="resize w" transform="translate(0,0)" style="cursor: ew-resize; display: none;"><rect x="-3" width="6" height="6" style="visibility: hidden;"></rect></g></g><g class="c3-axis-x" transform="translate(0,0)" clip-path="url(http://localhost:9876/context.html#c3-42-clip-xaxis)" style="visibility: hidden; opacity: 1;"><g class="tick" transform="translate(5, 0)" style="opacity: 1;"><line x1="0" x2="0" y2="6"></line><text x="0" y="9" transform="" style="text-anchor: middle; display: block;"><tspan x="0" dy=".71em" dx="0">0</tspan></text></g><g class="tick" transform="translate(459, 0)" style="opacity: 1;"><line x1="0" x2="0" y2="6"></line><text x="0" y="9" transform="" style="text-anchor: middle; display: block;"><tspan x="0" dy=".71em" dx="0">6</tspan></text></g><path class="domain" d="M0,6V0H463V6"></path></g></g><g transform="translate(0,480)"><g class="c3-legend-item c3-legend-item-calculated" style="visibility: hidden; cursor: pointer;"><text x="180.9765625" y="9" style="pointer-events: none;">calculated</text><rect class="c3-legend-item-event" x="166.9765625" y="-5" width="0" height="0" style="fill-opacity: 0;"></rect><line class="c3-legend-item-tile" x1="164.9765625" y1="4" x2="174.9765625" y2="4" stroke-width="10" style="stroke: rgb(31, 119, 180); pointer-events: none;"></line></g><g class="c3-legend-item c3-legend-item-Identity-Line" style="visibility: visible; cursor: pointer;"><text x="180.9765625" y="9" style="pointer-events: none;">Identity Line</text><rect class="c3-legend-item-event" x="166.9765625" y="-5" width="91.03125" height="18" style="fill-opacity: 0;"></rect><line class="c3-legend-item-tile" x1="164.9765625" y1="4" x2="174.9765625" y2="4" stroke-width="10" style="stroke: rgb(255, 127, 14); pointer-events: none;"></line></g><g class="c3-legend-item c3-legend-item-Correlation" style="visibility: visible; cursor: pointer;"><text x="272.0078125" y="9" style="pointer-events: none;">Correlation</text><rect class="c3-legend-item-event" x="258.0078125" y="-5" width="75.015625" height="18" style="fill-opacity: 0;"></rect><line class="c3-legend-item-tile" x1="256.0078125" y1="4" x2="266.0078125" y2="4" stroke-width="10" style="stroke: rgb(44, 160, 44); pointer-events: none;"></line></g></g><text class="c3-title" x="250" y="0"></text></svg><div class="c3-tooltip-container" style="position: absolute; pointer-events: none; display: none;"></div></div>';

        const result = wrapper.find('div.poly-corr-chart').html();
        expect(result).toLookLikeSVG(expected);
        jasmine.clock().uninstall();
    });
});

<!DOCTYPE html>
<html>
    <head>
        <title>Quality Control Prototype</title>
        <meta charset="utf-8" />
        <script src="js/external/jquery.js"></script>
        <script src="js/external/bootstrap.js"></script>
        <script src="js/external/d3.js"></script>
        <script src="js/external/jquery.treetable.js"></script>
        <script src="js/external/jquery.modal.js"></script>
        <script src="js/external/jquery-ui.js"></script>
        <script src="js/external/bootstrap-toggle.js"></script>
        <script src="js/external/spin.js"></script>

        <script src="js/qc_normHelper.js?ver=1.0.0"></script>
        <script src="js/qc_normDrawPlate.js?ver=1.0.0"></script>
        <script src="js/qc_normDrawCurves.js?ver=1.0.0"></script>
        <script src="js/qc_normAPIHelper.js?ver=1.0.0"></script>

        <link href="style/qc_norm.css" rel="stylesheet"/>
        <link href="style/bootstrap.css" rel="stylesheet"/>
        <link href="style/main.css" rel="stylesheet"/>
        <link href="style/jquery.treetable.css" rel="stylesheet" />
        <link href="style/jquery.treetable.theme.default.css" rel="stylesheet" />
        <link href="style/bootstrap-toggle.min.css" rel="stylesheet" />
        <link href="style/jquery.modal.css" rel="stylesheet" />
        <link href="style/jquery-ui.css" rel="stylesheet" />


    </head>
<body>
    <script>
        $(window)
            .unload(function () {
                var lock_key = $("#spLock").data("lock_key");
                var unlockPath = $("#spLock").data("unLock_path");
                if (unlockPath) {
                    $("#divLockRemoving").show();
                    RemoveLock(unlockPath,
                        lock_key,
                        function (success) {
                            $("#spLock").text("Read/Write");
                            $("#divLockRemoving").hide();
                        });
                };
            });

        $(document)
            .ready(function () {
                var branchSymbol = "Â¤";
                var qIndexQueue = [];
                var qIndexCurrent = 0;
                var currentSelectedPlate;
                var selRunNormPhenotypesName = "selRunNormPhenotypes";
                var selRunPhenotypesName = "selRunPhenotypes";
                var opts = {
                    lines: 9, // The number of lines to draw
                    length: 9, // The length of each line
                    width: 5, // The line thickness
                    radius: 20, // The radius of the inner circle
                    color: '#000000', // #rgb or #rrggbb or array of colors
                    speed: 1.9, // Rounds per second
                    trail: 40, // Afterglow percentage
                    className: 'spinner' // The CSS class to assign to the spinner
                };
                var qIdxOperations = {
                    Current: 0,
                    Prev: -1,
                    Next: 1
                }

                createMarkButtons();
                var target = document.getElementById("divLoading");
                var spinner = new Spinner(opts).spin(target);
                var dispatch = d3.dispatch("setExp", "reDrawExp");
                spinner.stop();

                $("#divLockRemoving").hide();
                $("#ckMarkExperiments").change(function () {
                    $("#divMarkStates").toggle();
                    $("#qidxHint").toggle();
                    if (this.checked) {
                        setExperimentByQidx(qIdxOperations.Current);
                    }
                });
                $("#ckNormalized").change(function () {
                    $("#" + selRunNormPhenotypesName).toggle();
                    $("#" + selRunPhenotypesName).toggle();
                    if (this.checked) {
                        $("#" + selRunNormPhenotypesName).prop('selectedIndex', 14);
                        $("#" + selRunNormPhenotypesName).change();
                        drawPhenotypePlatesSelection();
                    }
                });
                $("#inMarkArea").change(function () {
                    allowMarking = this.checked;
                });
                $("#btnNormalizeProject").click(function () {
                    if (confirm("This will overwrite any previous normalization data, are you sure?")) {
                        var project = $("#spProject").text();
                        var lockKey = getLock_key();
                        wait();
                        GetNormalizeProject(project, lockKey, function (data) {
                            if (data.success === true)
                                alert("Succeded!");
                            else
                                alert("Failed! - " + data.reason);
                            stopWait();
                        });
                    }
                });
                $("#lnkExportAbsolute").click(function () {
                    var project = $("#spProject").text();
                    var url = "/api/results/export/phenotypes/Absolute/" + project;
                    wait();
                    e.preventDefault();
                    window.location.href = url;
                });
                $("#lnkNormalizedRelative").click(function () {
                    var project = $("#spProject").text();
                    var url = "/api/results/export/phenotypes/NormalizedRelative/" + project;
                    wait();
                    GetExport(url, function () {
                        stopWait();
                    });
                });
                $("#lnkNormalizedAbsoluteBatched").click(function () {
                    var project = $("#spProject").text();
                    var url = "/api/results/export/phenotypes/NormalizedAbsoluteBatched/" + project;
                    wait();
                    GetExport(url, function () {
                        stopWait();
                    });
                });
                $("#btnRefreshKey").click(function () {
                    getLock(function () { });
                });
                $("#btnMarkOK").click(function () {
                    markExperiemnt(plateMetaDataType.OK, false);
                });
                $("#btnMarkBad").click(function () {
                    markExperiemnt(plateMetaDataType.BadData, false);
                });
                $("#btnMarkEmpty").click(function () {
                    markExperiemnt(plateMetaDataType.Empty, true);
                });
                $("#btnMarkNoGrowth").click(function () {
                    markExperiemnt(plateMetaDataType.NoGrowth, true);
                });
                $("#btnQidxNext").click(function () {
                    setExperimentByQidx(qIdxOperations.Prev);
                });
                $("#btnQidxPrev").click(function () {
                    setExperimentByQidx(qIdxOperations.Next);
                });
                $(document).keypress(function (event) {
                    var char = getChar(event).toLowerCase();
                    switch (char) {
                        case 'q':
                            markExperiemnt(plateMetaDataType.OK, false);
                            break;
                        case 'w':
                            markExperiemnt(plateMetaDataType.BadData, false);
                            break;
                        case 'e':
                            markExperiemnt(plateMetaDataType.Empty, true);
                            break;
                        case 'r':
                            markExperiemnt(plateMetaDataType.NoGrowth, true);
                            break;
                        case '1':
                            $("#btnPlate0").focus();
                            document.getElementById("btnPlate0").click();
                            break;
                        case '2':
                            $("#btnPlate1").focus();
                            document.getElementById("btnPlate1").click();
                            break;
                        case '3':
                            $("#btnPlate2").focus();
                            document.getElementById("btnPlate2").click();
                            break;
                        case '4':
                            $("#btnPlate3").focus();
                            document.getElementById("btnPlate3").click();
                            break;
                    }
                });
                $(document).keydown(function (e) {
                    if (!isQualityControlOn()) return;
                    switch (e.which) {
                        case 37: // left
                        case 40: // down
                            setExperimentByQidx(qIdxOperations.Prev);
                            break;
                        case 38: // up
                        case 39: // right
                            setExperimentByQidx(qIdxOperations.Next);
                            break;
                        default: return;
                    }
                    e.preventDefault();
                });

                function setExperimentByQidx(operation) {
                    var queue = getQIndexCoord(operation);
                    var row = queue.row;
                    var col = queue.col;
                    dispatch.setExp("id" + row + "_" + col);
                }

                function setExperimentByCoord(row, col) {
                    dispatch.setExp("id" + row + "_" + col);
                }

                function isQualityControlOn() {
                    var on = $("#divMarkStates").is(':visible');
                    return on;
                }

                function getQIndexCoord(operation) {
                    qIndexCurrent = qIndexCurrent + operation;
                    var maxQueueSize = qIndexQueue.length - 1;
                    if (qIndexCurrent < 0)
                        qIndexCurrent = maxQueueSize;
                    if (qIndexCurrent > maxQueueSize)
                        qIndexCurrent = 0;
                    var item = qIndexQueue[qIndexCurrent];
                    return item;
                }

                function getChar(event) {
                    if (event.which == null) {
                        return String.fromCharCode(event.keyCode); // IE
                    } else if (event.which != 0 && event.charCode != 0) {
                        return String.fromCharCode(event.which); // the rest
                    } else {
                        return null; // special key
                    }
                }

                function wait() {
                    $("#divLoading").modal({ escapeClose: false, clickClose: false, showClose: false });
                    spinner.spin(target);
                }

                function stopWait() {
                    spinner.stop();
                    $.modal.close();
                }

                function getLock_key() {
                    return $("#spLock").data("lock_key");
                }

                function isPlateAllNull(plateData) {
                    for (var i = 0, len = plateData.length; i < len; i += 1)
                        for (var j = 0, lenj = plateData[1].length; j < lenj; j += 1)
                            if (plateData[i][j] !== null)
                                return false;

                    return true;
                }

                function createMarkButton(buttonId, type) {
                    var btn = d3.select(buttonId)
                        .append("svg")
                        .attr({
                            "width": 25,
                            "height": 25
                        });
                    addSymbolToSGV(btn, type);
                    btn.append("use")
                        .attr({
                            "xlink:href": "#" + getValidSymbol(type),
                            "x": 0,
                            "y": 0,
                            "width": 25,
                            "height": 25
                        });
                };

                function createMarkButtons() {
                    createMarkButton("#btnMarkOK", plateMetaDataType.OK);
                    createMarkButton("#btnMarkBad", plateMetaDataType.BadData);
                    createMarkButton("#btnMarkEmpty", plateMetaDataType.Empty);
                    createMarkButton("#btnMarkNoGrowth", plateMetaDataType.NoGrowth);
                }

                function projectSlelectionStage(level) {
                    switch (level) {
                        case "project":
                            $("#displayArea").hide();
                            $("#dialogGrid").hide();
                            $(".loPhenotypeSelection").hide();
                            $(".loPlateSelection").hide();
                            $("#tbProjectDetails").hide();
                            $("#divMarkStates").hide();
                            $("#qidxHint").hide();

                            break;
                        case "Phenotypes":
                            $(".loPhenotypeSelection").show();
                            break;
                        case "Plates":
                            $("#displayArea").show();
                            $(".loPlateSelection").show();
                            d3.select("#selPhenotypePlates").remove();
                            break;
                        default:
                    }
                }

                //Mark Selected Experiment
                function markExperiemnt(mark, all) {
                    if (!isQualityControlOn()) return;
                    var plateIdx = $("#currentSelection").data("plateIdx");
                    var row = $("#currentSelection").data("row");
                    var col = $("#currentSelection").data("col");
                    var phenotype = $("#currentSelection").data("phenotype");
                    var project = $("#currentSelection").data("project");
                    // /api/results/curve_mark/set/<mark>/<phenotype>/<int:plate>/<int:d1_row>/<int:d2_col>/<path:project>"
                    var path = "";
                    if( all !== true)
                        path = "/api/results/curve_mark/set/" + mark + "/" + phenotype + "/" + plateIdx + "/" + row + "/" + col + "/" + project;
                    else
                        path = "/api/results/curve_mark/set/" + mark + "/" + plateIdx + "/" + row + "/" + col + "/" + project;
                    var lockKey = getLock_key();
                    wait();
                    GetMarkExperiment(path, lockKey, function (gData) {
                        if (gData.success === true) {
                            dispatch.reDrawExp("id" + row + "_" + col, mark);
                            var queueCurrent = getQIndexCoord(qIdxOperations.Current);
                            if (queueCurrent.row == row && queueCurrent.col == col)
                                setExperimentByQidx(qIdxOperations.Next);
                            else
                                setExperimentByQidx(qIdxOperations.Current);
                        }
                        else
                            alert(gData.success + " : " + gData.reason);
                        stopWait();
                    });
                }

                //draw Project selection
                BrowseProjectsRoot(function (browseData) {
                    if (browseData === null) {
                        alert("ERROR: There was a problem with the API!");
                        return;
                    }
                    projectSlelectionStage("project");
                    var selProjects = d3.select("#divProjectsSelector").append("table").attr("id", "tblProjects");
                    $(browseData)
                        .each(function (idx, elem) {
                            selProjects.append("tr")
                                .attr("data-tt-id", elem.url)
                                .attr("data-tt-branch", true)
                                .append("td")
                                .text(elem.name);
                        });
                    $("#tblProjects")
                        .treetable({
                            expandable: true,
                            onNodeExpand: nodeExpand,
                            onNodeCollapse: nodeCollapse
                        });
                });

                function nodeCollapse() {
                    //alert("Collapsed: " + this.id);
                }

                function nodeExpand() {
                    var parentId = this.id;
                    BrowsePath(parentId, function (browse) {
                        console.log("ParentID:" + parentId);
                        console.log("is project:" + browse.isProject);
                        console.log("paths len:" + browse.paths.length);
                        var parentNode = $("#tblProjects").treetable("node", parentId);
                        var nodeToAdd;
                        var row;
                        if (!browse.isProject && browse.paths.length === 0) {
                            nodeToAdd = $("#tblProjects").treetable("node", "empty" + parentId);
                            if (!nodeToAdd) {
                                row = '<tr data-tt-id="empty' + parentId + '" data-tt-parent-id="' + parentId + '" >';
                                row += "<td><span class='file'>This project is Empty ...</span></td>";
                                row += "</tr>";
                                $("#tblProjects").treetable("loadBranch", parentNode, row);
                            }
                        } else if (!browse.isProject) {
                            var rows = "";
                            $.each(browse.paths,
                                function (key, value) {
                                    row = '<tr data-tt-id="' + branchSymbol + value.url + '" data-tt-parent-id="' + parentId + '" data-tt-branch="true" >';
                                    row += "<td>" + value.name + "</td>";
                                    row += "</tr>";
                                    rows += row;
                                });
                            $("#tblProjects").treetable("loadBranch", parentNode, rows);
                            console.log("addedNodes rows:" + rows);
                        } else if (browse.isProject) {
                            nodeToAdd = $("#tblProjects").treetable("node", "project" + parentId);
                            if (!nodeToAdd) {
                                row = '<tr data-tt-id="project' + parentId + '" data-tt-parent-id="' + parentId + '"  >';
                                console.log("button id: " + browse.projectDetails);
                                row += "<td><button id='" + browse.projectDetails.project + "'>Here is your project</button></td>";
                                row += "</tr>";
                                $("#tblProjects").treetable("loadBranch", parentNode, row);
                                var btn = $(document.getElementById(browse.projectDetails.project));
                                btn.on("click", function () { fillProjectDetails(browse.projectDetails); });
                                btn.attr("class", "attached");
                            }
                        }
                    });
                    console.log("Expanded: " + this.id);
                }

                function getLock(callback) {
                    var lockPath = $("#spLock").data("lock_path");
                    wait();
                    GetAPILock(lockPath,
                        function (lockData) {
                            if (lockData != null) {
                                var lock = lockData.lock_key;
                                var permisssionText = lockData.lock_state;
                                $("#spLock").text(permisssionText);
                                $("#spLock").data("lock_key", lock);
                                $("#tbProjectDetails").show();
                                callback();
                                stopWait();
                            }
                        });
                }

                function fillProjectDetails(projectDetails) {
                    console.log("Project details:" + projectDetails.project);
                    $("#spProject_name").text(projectDetails.project_name);
                    $("#spProject").text(projectDetails.project);
                    $("#spExtraction_date").text(projectDetails.extraction_date);
                    $("#spAnalysis_date").text(projectDetails.analysis_date);
                    $("#spAnalysis_instructions").text(projectDetails.analysis_instructions);
                    $("#spLock").data("lock_path", projectDetails.add_lock);
                    $("#spLock").data("unLock_path", projectDetails.remove_lock);
                    $("#spQidx").data("qIdx", "");
                    var inner = "";
                    inner += "<li><a href='" + baseUrl + "/api/results/export/phenotypes/Absolute/" + projectDetails.project + "'>Absolute</a></li>";
                    inner += "<li><a href='" + baseUrl + "/api/results/export/phenotypes/NormalizedRelative/" + projectDetails.project + "'>Normalized Relative</a></li>";
                    inner += "<li><a href='" + baseUrl + "/api/results/export/phenotypes/NormalizedAbsoluteBatched/" + projectDetails.project + "'>Normalized Absolute Batched</a></li>";
                    $("#ulExport").html(inner);
                    getLock(function () {
                        $("#btnUploadMetaData").click(function () {
                            var key = $("#spLock").data("lock_key");
                            var addMetaDataUrl = baseUrl + "/api/results/meta_data/add/" + projectDetails.project + addKeyParameter(key);
                            var file = $("#meta_data")[0].files[0];
                            if (!file) {
                                alert("You need to select a valid file!");
                                return;
                            }
                            var extension = file.name.split('.').pop();
                            var formData = new FormData();
                            formData.append("meta_data", file);
                            formData.append("file_suffix", extension);
                            $.ajax({
                                url: addMetaDataUrl,
                                type: "POST",
                                contentType: false,
                                enctype: 'multipart/form-data',
                                data: formData,
                                processData: false,
                                success: function (data) {
                                    if (data.success == true)
                                        alert("The data was uploaded successfully:");
                                    else
                                        alert("There was a problem with the upload: " + data.reason);
                                },
                                error: function (data) {
                                    alert("error:" + data.responseText);
                                }
                            });
                        });
                        $("#btnBrowseProject").click();
                        drawRunPhenotypeSelection(projectDetails.phenotype_names);
                        drawRunNormalizedPhenotypeSelection(projectDetails.phenotype_normalized_names);
                        drawReferenceOffsetSelecton();
                    });
                }

                //draw Reference Offset selection
                function drawReferenceOffsetSelecton() {
                    var elementName = "selRefOffSets";
                    GetReferenceOffsets(function (offsets) {
                        d3.select("#" + elementName).remove();
                        var selPhen = d3.select("#divReferenceOffsetSelector")
                            .append("select")
                            .attr("id", elementName);
                        var options = selPhen.selectAll("optionPlaceholders")
                            .data(offsets)
                            .enter()
                            .append("option");
                        options.attr("value", function (d) { return d.value; });
                        options.text(function (d) { return d.name; });
                        $("#" + elementName).selectedIndex = 0;
                        drawPhenotypePlatesSelection();
                    });
                };

                //draw run phenotypes selection
                function drawRunPhenotypeSelection(path) {
                    projectSlelectionStage("Phenotypes");
                    console.log("Phenotypes path: " + path);
                    var lockKey = getLock_key();
                    GetRunPhenotypes(path, lockKey, function (runPhenotypes) {
                        d3.select("#" + selRunPhenotypesName).remove();
                        var selPhen = d3.select("#divRunPhenotypesSelector")
                            .append("select")
                            .attr("id", selRunPhenotypesName);
                        var options = selPhen.selectAll("optionPlaceholders")
                            .data(runPhenotypes)
                            .enter()
                            .append("option");
                        options.attr("value", function(d) {return d.url;});
                        options.text(function (d) { return d.name; });
                        selPhen.on("change", drawPhenotypePlatesSelection);
                        $("#" + selRunPhenotypesName).selectedIndex = 0;
                        drawPhenotypePlatesSelection();
                    });
                };

                function drawRunNormalizedPhenotypeSelection(path) {
                    console.log("Norm Phenotypes path: " + path);
                    var lockKey = getLock_key();
                    GetRunPhenotypes(path, lockKey, function (runPhenotypes) {
                        d3.select("#" + selRunNormPhenotypesName).remove();
                        var selPhen = d3.select("#divRunPhenotypesSelector")
                            .append("select")
                            .attr("id", selRunNormPhenotypesName);
                        var options = selPhen.selectAll("optionPlaceholders")
                            .data(runPhenotypes)
                            .enter()
                            .append("option");
                        options.attr("value", function(d) {return d.url;});
                        options.text(function (d) { return d.name; });
                        selPhen.on("change", drawPhenotypePlatesSelection);
                        $("#" + selRunNormPhenotypesName).toggle();
                    });
                };

                //draw phenotypes plates selection
                function drawPhenotypePlatesSelection() {
                    var isNormalized = $("#ckNormalized").is(':checked');
                    var selectedPhen = $("#" + selRunPhenotypesName).val();
                    var selectedNromPhen = $("#" + selRunNormPhenotypesName).val();
                    var path = isNormalized ? selectedNromPhen : selectedPhen;
                    if (!path)
                        return;
                    projectSlelectionStage("Plates");
                    console.log("plates: " + path);
                    var lockKey = getLock_key();
                    GetPhenotypesPlates(path, lockKey, function (phenotypePlates) {
                        //plate buttons
                        d3.selectAll(".plateSelectionButton").remove();
                        var selPlates = d3.select("#divPhenotypePlatesSelecton");
                        var buttons = selPlates.selectAll("buttonPlaceholders")
                            .data(phenotypePlates)
                            .enter()
                            .append("a");
                        buttons.attr({
                            "type": "button",
                            "class": "btn btn-default plateSelectionButton",
                            "id": function (d) { return "btnPlate" + d.index },
                            "href": "#",
                            "role": "button"
                        });
                        buttons.on("click", function (d) { renderPlate(d) });;
                        buttons.text(function (d) { return "Plate " + (d.index + 1); });
                        //griding buton
                        $("#divPhenotypePlatesSelecton")
                            .append("<a type='button' class='btn btn-default btn-xs plateSelectionButton' id='btnShowGrid' href='#' role='button'>Show Grid</a>");
                        $("#btnShowGrid").click(showGrid);
                        //check for plate index or load plate 0 by default
                        var plateIdx = $("#currentSelection").data("plateIdx");
                        var plateId = "btnPlate0";
                        if (plateIdx) plateId = "btnPlate" + plateIdx;
                        $("#"+plateId).focus();
                        document.getElementById(plateId).click();
                    });
                };

                function showGrid() {
                    var plateIdx = $("#currentSelection").data("plateIdx");
                    var project = $("#currentSelection").data("project");
                    var path = "/api/results/gridding/" + plateIdx + "/" + project;
                    $("#imgGridding").attr("src", baseUrl + path);
                    $("#dialogGrid").show();
                    $("#dialogGrid").dialog();
                };

                //draw plate
                function renderPlate(phenotypePlates) {
                    var path = phenotypePlates.url;
                    var plateIdx = phenotypePlates.index;
                    var project = $("#spProject").text();
                    currentSelectedPlate = plateIdx;
                    console.log("experiment: " + path);
                    $("#currentSelection").data("plateIdx", plateIdx);
                    $("#currentSelection").data("project", project);
                    $("#spnPlateIdx").text((plateIdx+1));
                    wait();
                    // e.g. /api/results/phenotype/GenerationTimeWhen/1/by4742_h/analysis
                    var isNormalized = $("#ckNormalized").is(':checked');
                    var phenotypePath = isNormalized ? "/api/results/normalized_phenotype/###/" : "/api/results/phenotype/###/";
                    var metaDataPath = phenotypePath + plateIdx + "/" + project;
                    var lockKey = getLock_key();
                    GetPlateData(path, isNormalized, metaDataPath, "###", lockKey, function (data) {
                        $("#plate").empty();
                        var allNull = isPlateAllNull(data.plate_data);
                        if (!data || allNull) {
                            stopWait();
                            return;
                        }
                        var plateData = data.plate_data;
                        var plateMetaData = data.Plate_metadata;
                        var growthMetaData = data.Growth_metaData;
                        var phenotypeName = data.plate_phenotype;
                        qIndexQueue = data.plate_qIdxSort;
                        var plate = DrawPlate("#plate", plateData, growthMetaData, plateMetaData, phenotypeName, dispatch);
                        var row = $("#currentSelection").data("row");
                        var col = $("#currentSelection").data("col");
                        if (row && col)
                            setExperimentByCoord(row, col);
                        stopWait();
                        plate.on("SelectedExperiment", function (datah) {
                                console.log("dispatched:" + datah.coord);
                                var arr = datah.coord.split(",");
                                var row = arr[0];
                                var col = arr[1];
                                $("#currentSelection").data("expId", datah.id);
                                $("#currentSelection").data("plateIdx", plateIdx);
                                $("#currentSelection").data("row", row);
                                $("#currentSelection").data("col", col);
                                $("#currentSelection").data("phenotype", datah.phenotype);
                                $("#currentSelection").data("project", $("#spProject").text());
                                // e.g. /api/results/curves/1/31/0/Martin_wt1/analysis
                                var expPath = "/api/results/curves/" + plateIdx + "/" + row + "/" + col + "/" + project;
                                console.log("curve path:" + expPath);
                                var lockKey = getLock_key();
                                GetExperimentGrowthData(expPath, lockKey, function (gData) {
                                    $("#graph").empty();
                                    DrawCurves("#graph", gData, datah.metaDataGt, datah.metaDataGtWhen, datah.metaDataYield);
                                });
                            });
                    });
                };
            });
    </script>

    <div id="divLoading" class="modal">
        <p>Talking to server ... </p>
    </div>
    <div id="cont" class="container QCCont">
        <h1>Quality Control</h1>
        <h2>Data Selection</h2>
        <div class="section-frame">
            <div class="row">
                <div class="col-md-12 loProjectSelection " style="height: 100%; width: 100%">
                    <div class="floating-box" style="width: 20%; horiz-align: center">
                        <a id="btnBrowseProject" class="btn " role="button" data-toggle="collapse" href="#selectProject" aria-expanded="false" aria-controls="selectProject">
                            <span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span>
                            Select a project
                        </a>
                    </div>
                    <div class="floating-box" style="width: 75%">
                        <div class="collapse" id="selectProject">
                            <div id="divProjectsSelector"></div>
                        </div>
                        <table id="tbProjectDetails">
                            <tr>
                                <td>Name</td>
                                <td><span id="spProject_name"></span></td>
                            </tr>
                            <tr>
                                <td>Directory</td>
                                <td><span id="spProject"></span></td>
                            </tr>
                            <tr>
                                <td>Extraction Date</td>
                                <td><span id="spExtraction_date"></span></td>
                            </tr>
                            <tr>
                                <td>Analysis Date</td>
                                <td><span id="spAnalysis_date"></span></td>
                            </tr>
                            <tr style="visibility: collapse">
                                <td>Analysis Instructions</td>
                                <td><span id="spAnalysis_instructions"></span></td>
                            </tr>
                            <tr>
                                <td>Nomalization</td>
                                <td>
                                    <div style="text-align:left">
                                        <div style="float: left"> Offset:</div>
                                        <div style="margin-left: 10px; float: left" id="divReferenceOffsetSelector"></div>
                                        <button style="margin-left: 10px; float: left" id="btnNormalizeProject" type="button" class="btn btn-default btn-xs" aria-label="Normalize project">
                                            Normalize
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Permissions</td>
                                <td>
                                    <span id="spLock"></span>
                                    <button id="btnRefreshKey" type="button" class="btn btn-default btn-xs" aria-label="refresh key">
                                        <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>Export Data</td>
                                <td>
                                    <div class="dropup">
                                        <button title="Note: Dosent work on Firefox!" class="btn btn-default btn-xs dropdown-toggle" type="button" id="ddmSave" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                            Export
                                            <span style="margin-left:5px" class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="ddmSave" id="ulExport"></ul>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    Load Metadata
                                </td>
                                <td>
                                    <input type="file" name="meta_data" id="meta_data" accept=".xls,.xlsx,.ods" />
                                    <input type="hidden" name="file_suffix" id="file_suffix" />
                                    <button id="btnUploadMetaData" class="btn btn-default btn-xs">
                                        Upload
                                    </button>
                                </td>
                            </tr>
                        </table>
                    </div>

                </div>
            </div>
            <div class="row">
                <br />
                <div class="col-md-12 loPhenotypeSelection">
                    <div style="float: left">
                        Phenotype:
                    </div>
                    <div style="float: left" id="divRunPhenotypesSelector"></div>
                    <div style="float: left">
                        Show Normalized Phenotypes
                        <input style="margin-left:5px" id="ckNormalized" type="checkbox" data-toggle="toggle" data-size="mini"/>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 loPlateSelection">
                    <div id="divPhenotypePlatesSelecton"></div>
                </div>
            </div>
        </div>
        <div class="section-frame" id="displayArea">
            <div class="row">
                <div class="col-md-7">
                    <div class="row">
                        <div class="col-md-7">
                            <h2 style="float: left">
                                Plate
                                <span id="spnPlateIdx">n</span>
                            </h2>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div>
                                Mark experiments
                                <input id="ckMarkExperiments" type="checkbox" data-toggle="toggle" data-size="mini"/>
                            </div>
                        </div>
                        <div id="divMarkStates" class="col-md-8">
                            <div id="currentSelection"></div>
                            <span class="vcenter" style="padding-right: 8px;visibility:collapse">
                                Area selection
                                <input class="vcenter" id="inMarkArea" type="checkbox" />
                            </span>
                            <button id="btnMarkOK" class="markButton vcenter" title="Mark with metadata: OK [hotkey: q]"></button>
                            <button id="btnMarkBad" class="markButton vcenter" title="Mark with metadata: Bad [hotkey: w]"></button>
                            <button id="btnMarkEmpty" class="markButton vcenter" title="Mark with metadata: Empty [hotkey: e]"></button>
                            <button id="btnMarkNoGrowth" class="markButton vcenter" title="Mark with metadata: NoGrowth [hotkey: r]"></button>
                            <button id="btnQidxNext" style="margin-left:10px" class="btn btn-default btn-xs" title="Next in Qidx position [hotkey: <right>/<up>]">
                                <span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span>
                            </button>
                            <button id="btnQidxPrev" class="btn btn-default btn-xs" title="Back in Qidx position [hotkey: <left>/<down>]">
                                <span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span>
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div id="plate"></div>
                            <span id="qidxHint">
                                Hint: Use the arrows to navigate the plate using the Qidx order.
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="row">
                        <div class="col-md-6">
                            <h2>Graph</h2>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 text-center">
                            <div id="sel"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div id="graph"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="text"></div>
    <div id="dialogGrid" title="Gridding">
        <img id="imgGridding" src="#" alt="Grid" />
    </div>

</body>

</html>
